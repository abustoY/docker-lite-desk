<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Docker GUI</title>
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.3.22/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.4.21/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@3.3.22/dist/vuetify.min.js"></script>
</head>

<body>
    <div id="app">
        <v-app>
            <v-main class="pa-4">
                <v-container>
                    <v-tabs v-model="tab" bg-color="grey-lighten-4">
                        <v-tab value="containers">コンテナ一覧</v-tab>
                        <v-tab value="images">イメージ一覧</v-tab>
                    </v-tabs>

                    <!-- 通知 -->
                    <v-alert v-if="message" type="success" class="my-4">{{ message }}</v-alert>
                    <v-alert v-if="error" type="error" class="my-4">{{ error }}</v-alert>

                    <!-- コンテナ一覧 -->
                    <div v-if="tab === 'containers'">
                        <v-btn @click="fetchContainers" color="primary" class="my-4">再読み込み</v-btn>
                        <v-card v-for="c in containers" :key="c.id" class="mb-4" variant="outlined">
                            <v-card-title>{{ c.name }} ({{ c.id }})</v-card-title>
                            <v-card-subtitle>イメージ: {{ c.image }}<br />状態: {{ c.status }}</v-card-subtitle>
                            <v-card-actions>
                                <v-btn v-if="c.status.includes('Exited')" color="green"
                                    @click="dockerAction('start', c.id)">Start</v-btn>
                                <v-btn v-if="c.status.includes('Up')" color="red"
                                    @click="dockerAction('stop', c.id)">Stop</v-btn>
                                <v-btn v-if="c.status.includes('Exited')" color="grey-darken-1"
                                    @click="dockerAction('rm', c.id)">Remove</v-btn>
                            </v-card-actions>
                        </v-card>
                    </div>

                    <!-- イメージ一覧 -->
                    <div v-if="tab === 'images'">
                        <v-btn @click="fetchImages" color="primary" class="my-4">再読み込み</v-btn>
                        <v-card v-for="img in images" :key="img.id" class="mb-4" variant="outlined">
                            <v-card-title>{{ img.repository }}:{{ img.tag }}</v-card-title>
                            <v-card-subtitle>ID: {{ img.id }} / サイズ: {{ img.size }}</v-card-subtitle>
                            <v-card-actions>
                                <v-btn color="red" @click="dockerAction('rmi', img.id)">Remove</v-btn>
                            </v-card-actions>
                        </v-card>
                    </div>
                </v-container>

            </v-main>
        </v-app>
    </div>

    <script>
        const { createApp, ref, watch } = Vue; // ← watch を追加
        const vuetify = Vuetify.createVuetify();
    
        createApp({
            setup() {
                const tab = ref('containers');
                const containers = ref([]);
                const images = ref([]);
                const message = ref('');
                const error = ref('');
    
                const fetchContainers = async () => {
                    try {
                        error.value = '';
                        containers.value = await window.api.getAllContainers();
                    } catch (e) {
                        error.value = e.message || '取得に失敗しました';
                    }
                };
    
                const fetchImages = async () => {
                    try {
                        error.value = '';
                        images.value = await window.api.getAllImages();
                    } catch (e) {
                        error.value = e.message || '取得に失敗しました';
                    }
                };
    
                const dockerAction = async (action, id) => {
                    const res = await window.api.dockerAction(action, id);
                    message.value = res;
                    setTimeout(() => (message.value = ''), 3000);
    
                    if (tab.value === 'containers') {
                        await fetchContainers();
                    } else if (tab.value === 'images') {
                        await fetchImages();
                    }
                };
    
                // 初回：アクティブなタブに応じて読み込み
                if (tab.value === 'containers') {
                    fetchContainers();
                } else if (tab.value === 'images') {
                    fetchImages();
                }
    
                // タブが切り替わった時にも自動で読み込み
                watch(tab, (newTab) => {
                    if (newTab === 'containers') {
                        fetchContainers();
                    } else if (newTab === 'images') {
                        fetchImages();
                    }
                });
    
                return {
                    tab,
                    containers,
                    images,
                    message,
                    error,
                    fetchContainers,
                    fetchImages,
                    dockerAction
                };
            }
        }).use(vuetify).mount('#app');
    </script>
    
    
</body>

</html>